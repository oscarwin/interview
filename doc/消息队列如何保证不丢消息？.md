## 消息队列如何保证不丢消息

消息队列从发送到消费会经历三个阶段：发送阶段、存储阶段和消费阶段。每个阶段都可能丢失消息，因此每个阶段都要实现消息的可靠性。

### 发送阶段

网络传输保证消息的可靠性，往往都是通过引入 ACK 机制来实现，消息队列的发送阶段一般也是通过这个方式来实现。

Producer 向消息队列的 Broker 发送消息，Broker 收到消息后会给 Producer 发送 ACK 消息，如果 producer 没有收到 ACK，那么 producer 会重新发送这条消息。

### 存储阶段

一般情况下 broker 集群会正常运行，不会有什么问题。

如果对消息的可靠性非常高，可以配置消息队列的存储方式。将持久化的方式改为，先将消息持久化到磁盘然后再发送 ACK 给 producer。之所以先持久化到磁盘再发送 ACK，是为了避免先 ACK 成功后，但是机器宕机了，导致消息丢失。如果是先写磁盘再 ACK 即使机器宕机了也能重启后从磁盘恢复。

如果 broker 是集群部署，可以配置消息发送到一个 broker 上，并且复制到其他 broker 上保存了副本再发送 ACK。

### 消费阶段

消费阶段与发送阶段保证消息可靠的方法相同，也是通过 ACK 机制来实现。consumer 消费成功后发送 ACK 给 broker，broker 收到 ACK 后删除这条消息，如果 consumer 消费失败没有发送 ACK，或者 ACK 消息因为网络问题丢失了，consumer 再次取消息都会再次取到这条消息。

在这三个阶段，都会因为各种问题导致消息重发，因此消费者需要做去重处理。这是另一个问题了。