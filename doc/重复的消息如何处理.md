## 重复的消息如何处理

为了解决[消息队列如何保证不丢消息](https://github.com/oscarwin/interview/blob/master/doc/消息队列如何保证不丢消息.md)这个问题，消息队列采用了很多重试的机制，重试的机制会导致消息重复，重复的消息该如何处理呢？

一言以蔽之：在消费端实现幂等。

### 什么是幂等？

在数学上，幂等有两种主要的定义：

1 在某二元运算下，幂等元素是指被自己重复运算（或对于函数是为复合）的结果等于它自己的元素。用式子表示就是：
```
    s * s = s
```

2 某一元运算为幂等的时，其作用在任一元素两次后会和其作用一次的结果相同。用式子表示就是：
```
    f(f(x)) = f(x);
```

在计算机学科领域，幂等就是用同样的入参调用一个函数方法，调用一次和调用 N 的产生的效果是一样的。看两个例子来直观感受一下。

下面有两条 SQL 语句：
```
update t set num = 10 where id = 1;
update t set num += 10 where id = 1; 
```
第一条语句采用赋值的方式，是幂等的，因此执行多少次结果都是10。但是第二条语句采用累加的方式，不是幂等的，执行一次和执行两次的结果不相同。


再看一个更加复杂点的例子。在业务开发中经常有好友相互关注这样的场景，假设使用一个字段来记录 A 和 B 的关系。用1表示 A 关注了 B，用2表示 B 关注了 A，用3表示 A 和 B 相互关注。

通过按位与的方式来实现就可以实现幂等，A 关注 B 时将1位置为1，B 关注 A 时将 2 位置为 1。如果位置1和位置2都是1说明 A 和 B 是相互关注了。通过这种方式就可以实现幂等的关注操作了。

```
update t set focus = focus & 0x01; // A 关注 B
update t set focus = focus & 0x02; // B 关注 A
update t set focus = focus & 0x03; // A 和 B 相互关注的
```

### 通过数据库的唯一索引来实现幂等

以电商的订单场景为例，下单成功后会发一条订单消息给物流系统，通知物流系统发货。

物流系统每收到一条消息就向数据库写入一条数据，可以在订单 ID 上建立唯一索引，这样订单消息重复时，再次插入一条同样的消息时插入就会失败。最后，不管有多少条消息都只会有一条物流发货记录产生。

### 通过条件比较来实现幂等

在缓存模式中有一种方案是异步更新缓存，就是当数据库发生更新后，发送一条消息给缓存系统，缓存系统收到消息后会更新缓存。重复的消息可能导致，一条先更新的消息反而后到达缓存系统，如果缓存系统直接更新，就会使用旧的数据覆盖掉新的数据。

因此可以引入一个版本号，每次更新前比较缓存中的版本号和消息中的版本号，如果缓存中的版本号比消息中的版本号小则更新缓存，否则不更新。这样就实现了幂等。

### 通过查询并比较来实现幂等

给每一条消息加一个唯一标识，每次执行消息之前先查询一遍该消息的唯一 ID 是否存在，不存在则执行，否则就不执行。不过要考虑并发情况，不能让两天消息同时查询都不存在，然后都执行成功。

参考：

[1] 维基百科

[2] 李玥 《消息队列高手课》